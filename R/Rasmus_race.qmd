---
title: "Rasmus_race"
format: html
---

## Coralation between race and survival

```{r}
#|message: false
library(here)
library(tidyverse)
library(ggplot2)
```

```{r}
#| message: false
df_full <- read_csv(here("data/med_data_tidy.csv"))

#Slice the dataframe to only include relevant columns. We keep the full dataset for backround
df <- df_full |> select(race,age,diag_group,diag_class,death) 

#filter out all rows where race was not specified, and count the abundance of each race in the study
df <- df |> filter(!is.na(race)) |> group_by(race)
df |> count() |> print() |> ungroup()
```

```{r}
race_plot1 <- ggplot(data=df)+
  geom_bar(aes(x=race)) +
  labs(title="Number of patients in the study, statified by race")+
  theme(panel.grid.major = element_blank())
  
race_plot1
```

Since asian and other make up such small parts of the study, we will limit the analysis to black, hispanic and white. We will evaluate later if the hispanic sample size is also too small.

## Extracting features

Now we will construct a tibble from summaries of grouped data

```{r}
df_race_stat1 <- df_race |> group_by(race) |>
  summarise(mean_age = mean(age),
            death_rate_any = mean(death),
            count_any = n(),
            se_death_any = sqrt(death_rate_any * (1-death_rate_any)/n()),
            CI_dra_lower = death_rate_any-se_death_any*2,
            CI_dra_upper = death_rate_any+se_death_any*2)

print(df_race_stat1)
```

```{r}
df_race_stat2 <- df_race |> group_by(race) |>
  filter(diag_class == "Cancer") |>
  summarise(death_rate_cancer = mean(death),
            mean_age_cancer = mean(age),
            count_cancer = n(),
            se_death_cancer = sqrt(death_rate_cancer * (1-death_rate_cancer)/n()),
            CI_drc_lower = death_rate_cancer-se_death_cancer*2,
            CI_drc_upper = death_rate_cancer+se_death_cancer*2)

df_race_stat <- df_race_stat1 |> full_join(df_race_stat2, by = "race") # joining cancer and total death rates
df_race_stat
```

```{r}
ggplot(df_race_stat,
       mapping = aes(x=race,y=death_rate_any))+
  geom_col(fill='midnightblue')+
  geom_errorbar(aes(ymin=CI_dra_lower, ymax=CI_dra_upper))+
  labs(title = "Death rates of pateints of different races in the study with 2 std errorbars", y = 'Death rate', x='Race')
```

The cancer scope is likely too small to derive any real meaning from here.
