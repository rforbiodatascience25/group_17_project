---
title: "Price effect"
format: html
editor: visual
---

# How does income impact death rate?

## Load libraries and data

### Load libraries

```{r}
#| message: false
library(tidyverse)
library(here)
```

### Load data

```{r}
#| message: false
meta_data <- read_csv("../data/med_data_tidy.csv")
```

## Preparing the data for analysis

```{r}
clean_data <- meta_data |>
  select(age, death, sex, diag_group, diag_class, income) |>
  mutate(income = gsub("\\$", "", income)) |> #To remove $ from the data
  na.omit()

clean_data
```

### Cleaning the income column and adding new column

```{r}
clean_data <- clean_data |>
  mutate(
    income_class = case_when(income == "under 11k" ~ "income very poor",
      income == "11-25k"    ~ "income poor",
      income == "25-50k"    ~ "income medium",
      income == ">50k"      ~ "income wealthy"
    ),
    income_num = case_when(income == "under 11k" ~ 11,
      income == "11-25k"    ~ 18,
      income == "25-50k"    ~ 37.5,
      income == ">50k"      ~ 50),
    income = factor(income, levels = c("under 11k", "11-25k", "25-50k", ">50k")))

clean_data
```

## Distribution plot

```{r}
income_plot <- ggplot(data = clean_data) +
  geom_bar(aes(x = income,
               fill = sex,), 
           position = "dodge") +
  labs(title="Distribution of income and sex in dataset")
  
income_plot
```

```{r}
ggsave(filename=here("results/plots/wealth_distribution.png"),
       plot=income_plot,
       height = 5,
       width=8)
```

## Making the regression line

### Making models for comparison

```{r}
clean_data
```

Defining the columbs

```{r}
df_income <- clean_data |>
  mutate(
    verypoor = case_when(income_class == "income very poor" ~ 1, .default = 0),
    poor     = case_when(income_class == "income poor" ~ 1, .default = 0),
    middle   = case_when(income_class == "income medium" ~ 1, .default = 0),
    wealthy  = case_when(income_class == "income wealthy" ~ 1, .default = 0))
df_income
```

creating linear models

```{r}
model_verypoor <- lm(death ~ verypoor, data = df_income)
model_poor     <- lm(death ~ poor, data = df_income)
model_middle   <- lm(death ~ middle, data = df_income)
model_wealthy  <- lm(death ~ wealthy, data = df_income)


```

```{r}
df_income_stat_models <- tibble(
  group = c("Income very low", "Income low", "Income medium", "Income wealthy"),
  model  = list(model_verypoor, model_poor, model_middle, model_wealthy))

df_income_stat_models
```

```{r}
df_income_models <- df_income_stat_models |>
  write_rds(here("data/models/income.RDS"))

```
