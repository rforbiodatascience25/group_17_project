---
title: "Sex analysis"
format: html
---

# Load packages
```{r}
library(dplyr)
library(ggplot2)
library(tibble)
library(here)
```

# Load data
```{r}
df <- read.csv(here("data", "med_data_tidy.csv"))
df
```
```{r}
# Preprocess: correct sex order and create cancer subset
df <- df |>
mutate(sex = factor(sex, levels = c("female", "male")))

df_cancer <- df |> filter(diag_class == "Cancer")
```


```{r}
#stats
summarise_by_sex <- function(data) {
data |>
group_by(sex) |>
summarise(
n = n(),
death_rate = mean(death, na.rm = TRUE),
survival_rate = 1 - death_rate,
se = sqrt(death_rate * (1 - death_rate) / n),
CI_lower = death_rate - 2 * se,
CI_upper = death_rate + 2 * se,
.groups = "drop"
)
}
total_stats  <- summarise_by_sex(df)
cancer_stats <- summarise_by_sex(df_cancer)

print(total_stats)
print(cancer_stats)
```


```{r}
# Plot: survival for all patients
ggplot(df, aes(x = sex, fill = factor(death))) +
geom_bar(position = "fill") +
labs(
y = "Proportion",
fill = "Death (1 = died)",
title = "Total Survival by Sex"
)

```



```{r}
# Plot: survival for cancer patients
ggplot(df_cancer, aes(x = sex, fill = factor(death))) +
geom_bar(position = "fill") +
labs(
y = "Proportion",
fill = "Death (1 = died)",
title = "Cancer Survival by Sex"
)
```


```{r}
# we can perform chi-square tests to get p_value 
chi_total  <- chisq.test(table(df$sex, df$death))
chi_cancer <- chisq.test(table(df_cancer$sex, df_cancer$death))

chi_total
chi_cancer
```

```{r}
# Linear models and RÂ²
model_total  <- lm(death ~ sex, data = df)
model_cancer <- lm(death ~ sex, data = df_cancer)

R2_total  <- summary(model_total)$r.squared
R2_cancer <- summary(model_cancer)$r.squared

R2_total
R2_cancer
```

```{r}
# Combined result table

combined_table <- tibble::tibble(
Analysis        = c("All patients", "Cancer patients"),
Chi_square_p    = c(chi_total$p.value, chi_cancer$p.value),
R2              = c(R2_total,       R2_cancer),
Male_death_rate = c(
total_stats$death_rate[total_stats$sex == "male"],
cancer_stats$death_rate[cancer_stats$sex == "male"]
),
Female_death_rate = c(
total_stats$death_rate[total_stats$sex == "female"],
cancer_stats$death_rate[cancer_stats$sex == "female"]
),
SE_male = c(
total_stats$se[total_stats$sex == "male"],
cancer_stats$se[cancer_stats$sex == "male"]
),
SE_female = c(
total_stats$se[total_stats$sex == "female"],
cancer_stats$se[cancer_stats$sex == "female"]
),
N_male = c(
total_stats$n[total_stats$sex == "male"],
cancer_stats$n[cancer_stats$sex == "male"]
),
N_female = c(
total_stats$n[total_stats$sex == "female"],
cancer_stats$n[cancer_stats$sex == "female"]
)
)

combined_table

```

```{r}
# DF_result with nested models

DF_result <- tibble(
Analysis = c("All patients", "Cancer patients"),
models   = list(model_total, model_cancer)
) |>
left_join(combined_table, by = "Analysis") |>
mutate(variable = "sex", .before = 1)

DF_result

summary(DF_result$models[[1]])  # total
summary(DF_result$models[[2]])  # cancer

```


```{r}
# Create male_binary and survival variables
df <- df |>
mutate(male_binary = ifelse(sex == "male", 1, 0),
       female_binary = ifelse(sex == "female", 1, 0)
)
head(df[, c("sex", "male_binary", "female_binary")])

```

```{r}
female_model <- lm(death ~ female_binary, data = df)
male_model <-   lm(death ~ male_binary, data = df)

model_df <- tibble(
group = c("female", "male"),
model = list(female_model, male_model)
)

model_df
```

```{r}
saveRDS(model_df, here("data/models/sex.RDS"))

readRDS(here("data", "models", "sex.RDS"))
```
```{r}
summary(model_df$model[[1]])
summary(model_df$model[[2]])
```


