---
title: "Rasmus_race"
format: html
---

## Coralation between race and survival

```{r}
#|message: false
library(here)
library(tidyverse)
library(ggplot2)
library(glue)

```

```{r}
#| message: false
df_full <- read_csv(here("data/med_data_tidy.csv"))

#Slice the dataframe to only include relevant columns. We keep the full dataset for backround
df <- df_full |> select(race,age,diag_group,diag_class,death) 

#filter out all rows where race was not specified, and count the abundance of each race in the study
df_race <- df |> filter(!is.na(race)) |> group_by(race)
df_race |> count() |> print() |> ungroup()
```

```{r}
race_plot1 <- ggplot(data=df_race)+
  geom_bar(aes(x=race),fill='midnightblue', alpha=0.7,color='darkgray') +
  labs(title="Number of patients in the study, statified by race")+
  theme(panel.grid.major = element_blank())
  
  
race_plot1 |> ggsave(file=here("results/plots/race_distribution.png"),
                     plot=_,
                     height=5, width=7)
race_plot1
```

Since asian and other make up such small parts of the study, we will limit the analysis to black, hispanic and white. We will evaluate later if the hispanic sample size is also too small.

```{r}
df_race <- df_race |> 
  filter(race %in% c('white','black','hispanic'))
df_race
```

## Extracting features

Now we will construct a tibble from summaries of grouped data

```{r}
df_race_stat <- df_race |> group_by(race) |>
  summarise(mean_age = mean(age),
            death_rate = mean(death),
            count = n(),
            se_death = sqrt(death_rate * (1-death_rate)/n()),
            CI_dra_lower = death_rate-se_death*2,
            CI_dra_upper = death_rate+se_death*2)

print(df_race_stat)
```

We also wanna add a row that contain the data for all patents to compare.

```{r}
race_plot2 <- ggplot(df_race_stat,
                     mapping = aes(x=race,y=death_rate))+
  geom_col(fill='midnightblue',alpha=0.7)+
  geom_errorbar(aes(ymin=CI_dra_lower, ymax=CI_dra_upper))+
  labs(title = "Death rates of pateints of different races in the study with 2 std errorbars",
       y = 'Death rate',
       x='Race',
       subtitle = "Sample size in '()'") +
  scale_x_discrete(labels = function(x) glue("{x} ({df_race_stat1$count})"))

race_plot2 |> ggsave(file=here("results/plots/race_death_distribution.png"),
                     plot=_,
                     height=5, width=7)
race_plot2
```

No race has a significantly different survival rate in the study.

## Modelling the effect of race on survival

Finally, we will nest a linear model into the dataframe that tries to use race to explain death rate. First, we will make a boolean columb for each race

```{r}
df_race <- df_race |>
  mutate(white = case_when(race=="white"~1,
                           .default = 0),
         black = case_when(race=="black"~1,
                           .default = 0),
         hispanic = case_when(race=="hispanic"~1,
                           .default = 0)) 


model_white = lm(formula = death~white,
                 data=df_race)
model_black = lm(formula = death~black,
                 data=df_race)
model_hispanic = lm(formula = death~hispanic,
                 data=df_race)

df_race_stat_models <- tibble(race = c('white','black','hispanic'),
                              model = list(model_white,model_black,model_hispanic))
df_race_stat <- df_race_stat |> right_join(df_race_stat_models, by='race') 
df_race_stat |> select(race, model)
```

Now we add a column called group to merge it with the other analysis.

```{r}
df_race_models <- df_race_stat |>
  mutate(group = str_glue("race_{race}")) |>
  select(group,model)
df_race_models |> write_rds(here("data/models/race.RDS"))
df_race_models
```
